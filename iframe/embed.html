<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Svalbardkartet IFrame</title>
    <link rel="stylesheet" type="text/css" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/dojo/dijit/themes/claro/claro.css">    
	<link href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/css/esri.css" rel="stylesheet" type="text/css" >
	<link rel="stylesheet" type="text/css" href="css/main.min.css">
	<script type="text/javascript" src="js/proj4js.min.js"></script>
    <script type="text/javascript">var djConfig = {parseOnLoad: true};</script>
    <script type="text/javascript" src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=3.5"></script>
    <script type="text/javascript">
      dojo.require("dijit.layout.BorderContainer");
      dojo.require("dijit.layout.ContentPane");
      dojo.require("esri.map");
dojo.require("esri.dijit.Popup");
      var map, geometryService;
      var overlayMapService = 'http://willem3.npolar.no/arcgis/rest/services/Svalbard/embed/MapServer';
      var layers = [{ name: 'HvalrossLiggeplasser', id: 2 }, { name: 'Røye', id: 3 }, { name: 'Sjøfugl kolonier', id: 5 }, { name: 'Alle Sjøpattdyr observasjoner', id: 27 }, { name: 'Isbjørn observasjoner', id: 37 }, { name: 'Strandrydding per år', id: 58 }, { name: 'Reinbestandområder', id: 59 }, { name: 'Biogeografiske soner', id: 60 }, { name: 'Vegetasjon (10 kasser)', id: 62}, { name: 'Geologi', id: 87 }];
      var geometryServiceUrl = 'http://geodata.npolar.no/arcgis/rest/services/Utilities/Geometry/GeometryServer';
	  var decimalPlacesWGS84 = 6;
	  var opacity =0.8;
	  var visible = [];
	  var visibleLayers = [];
	  var IFpoigraphicid = 1;
	  var IFgraphicLayer;
	  var pts = [];
      var identifyTask, identifyParams, identifyHandle = 0;

      // Read a page's GET URL variables and return them as an associative array.
      function getUrlVars() {
          var vars = [], hash;
          var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
          for (var i = 0; i < hashes.length; i++) {
              hash = hashes[i].split('=');
              vars.push(hash[0]);
              vars[hash[0]] = hash[1];
          }
          return vars;
      }
      
      //var p  = $("pre"),
    var qStr = "test=Hello&person[]=jeff&person[]=jim&person[extra]=john&test3&nocache="+(+new Date()),
    result = "",
    urlParams = {};

if (!window.location.search)
    window.location.href = window.location.href.replace("/edit") + "?" + qStr;

(function () {
    var e,
        d = function (s) { return decodeURIComponent(s).replace(/\+/g, " "); },
        q = window.location.search.substring(1),
        r = /([^&=]+)=?([^&]*)/g;

    while (e = r.exec(q)) {
        if (e[1].indexOf("[") == "-1")
            urlParams[d(e[1])] = d(e[2]);
        else {
            var b1 = e[1].indexOf("["),
                aN = e[1].slice(b1+1, e[1].indexOf("]", b1)),
                pN = d(e[1].slice(0, b1));
          
            if (typeof urlParams[pN] != "object")
                urlParams[d(pN)] = {},
                urlParams[d(pN)].length = 0;
            
            if (aN)
                urlParams[d(pN)][d(aN)] = d(e[2]);
            else
                Array.prototype.push.call(urlParams[d(pN)], d(e[2]));

        }
    }
})();
/*
if (JSON)
    result = JSON.stringify(urlParams, null, 4);
else {
    
    
    result = "urlParams: \r\n";
    
    for (var k in urlParams)
      if (typeof urlParams[k] == "object") {
        result += "    " + k + ":\r\n";
        for (var k2 in urlParams[k])
          result += "        " + k2 + ": " + urlParams[k][k2] + "\r\n";
      } 
      else
        result += "    " + k + ":" + urlParams[k] + "\r\n";
    
} 
*/
      function init() {
          geometryService = new esri.tasks.GeometryService(geometryServiceUrl);
          dojo.connect(geometryService, "onProjectComplete", onProjectComplete);
          
          IFgraphicLayer = new esri.layers.GraphicsLayer();
          //dojo.connect(IFgraphicLayer,"onClick", IFpoigraphicpointf);
          dojo.connect(IFgraphicLayer,"onMouseOver", IFpoigraphicpointf);
          var width = urlParams["width"];
          var height = urlParams["height"];
          dojo.style("map", "width", width + "px");
          dojo.style("map", "height", height + "px");
          var slider = true;

          if (urlParams["n"])
              slider = (urlParams["n"] * 1 == 0);
          if (urlParams["extent"]) {
              var extent = urlParams["extent"].split(',');
              //dojo.byId('fullmap').innerHTML = '<a id="fullmaplink" href="http://svalbardkartet.npolar.no/Viewer.html?Viewer=Svalbardkartet&extent='+ extent + '" target="_blank">Vis i Svalbardkartet</a>';
              var wkid = "32633";
              if (urlParams["wkid"]) wkid = urlParams["wkid"];
              var initExtent = new esri.geometry.Extent({ "xmin": extent[0] * 1, "ymin": extent[1] * 1, "xmax": extent[2] * 1, "ymax": extent[3] * 1, "spatialReference": { "wkid": 32633} });
              //var initExtent = new esri.geometry.Extent({ "xmin": -13635568, "ymin": 4541606, "xmax": -13625430, "ymax": 4547310, "spatialReference": { "wkid": 102100} });
              map = new esri.Map("map", {extent: initExtent, logo: false });
          }
          else {
              map = new esri.Map("map", {logo: false });
          }
          
          var basemap = null;
          //var mapUrl = "http://geodata.npolar.no/ArcGIS/rest/services/inspire1/NP_TopoNordomr_U33_CHL/MapServer";
          //var mapUrl2 = "http://geodata.npolar.no/ArcGIS/rest/services/inspire1/NP_TopoNordomr_U33_CHX/MapServer";
          var mapUrl = decodeURIComponent(urlParams["mapUrl"]);
          if (urlParams["t"] && urlParams["t"] == "1")
              basemap = new esri.layers.ArcGISTiledMapServiceLayer(mapUrl);
          else
              basemap = new esri.layers.ArcGISDynamicMapServiceLayer(mapUrl);
              //basemap = new esri.layers.ArcGISTiledMapServiceLayer(mapUrl2);
          map.addLayer(basemap);
          // set the layer opacity
          if (urlParams["opValue"]<=1 && urlParams["opValue"]>=0)
              opacity = urlParams["opValue"];	
          	
          if (urlParams["cl"]) {
              var overlayMap = new esri.layers.ArcGISDynamicMapServiceLayer(overlayMapService, {showAttribution: false, opacity: opacity });
              overlayMap.id = 'overlayMap';
              
              dojo.forEach(urlParams["cl"].split(";"), function(item) {
                  visibleLayers.push(1 * item);
              });
              overlayMap.setVisibleLayers(visibleLayers);
              map.addLayer(overlayMap);
          }
          
          showFullMap();
          dojo.connect(map, "onExtentChange", showFullMap);
          dojo.connect(map, "onClick", updateIdentifyTask);
          
          dojo.connect(map, "onLoad", function() {
          	initIdentify(map);
          	// Disables map zooming using mouse scroll wheel.
              if (!slider) {
              	map.disableScrollWheelZoom();
                  //map.disableMapNavigation();
                  //map.hideZoomSlider();
              }
              



            if (urlParams["poi"]) {
            	
            for (var i = 0; i < urlParams["poi"].length; i++){
            	//console.log(urlParams["poi"][i]);
            	var values = [];
            	values = urlParams["poi"][i].split(',');
            	
			IFurlpoilat = values[0];
			//IFurlpoilat = IFurlpoilat.replace(",",".");
			IFurlpoilong = values[1];
			poiColor = values[2];
			IFurlpoititle = values[3];
			IFurlpoiinfo = values[4];
            	
            	if (poiColor == "r") {
				poiSymbol = new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE, 10, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255, 0, 0]), 2), new dojo.Color([255, 0, 0]));
			}	
			if (poiColor == "g") {
				poiSymbol = new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE, 10, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([0, 255, 0]), 2), new dojo.Color([0, 255, 0]));					
			}	
			if (poiColor == "b") {
				poiSymbol = new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE, 10, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([0, 0, 255]), 2), new dojo.Color([0, 0, 255]));
			}
			if (poiColor == "y") {
				poiSymbol = new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE, 10, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255, 0, 0]), 2), new dojo.Color([255, 0, 0]));
			}
			
			else if (poiColor == "") {
			poiSymbol = new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE, 10, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255, 0, 0]), 2), new dojo.Color([255, 0, 0]));
			}
            	
            	IFpoiupos = new Proj4js.Point(IFurlpoilong,IFurlpoilat);
			//Proj4js.transform(u33, w84, IFpoiupos);
			//IFpoipl = {"geometry":{"x":IFpoiupos.x,"y":IFpoiupos.y},"spatialreference":{"wkid":32633},"attributes":{"Title":IFurlpoititle,"Info":IFurlpoiinfo}};
			IFpoipl = {"geometry":{"x":IFurlpoilat,"y":IFurlpoilong},"attributes":{"Title":IFurlpoititle,"Info":IFurlpoiinfo}};
			IFpoigraphic = new esri.Graphic(IFpoipl);
			//IFpoigraphic = new esri.Graphic(new esri.geometry.Point(IFurlpoilat,IFurlpoilong));			
			IFpoigraphic.setSymbol(poiSymbol);
			IFpoigraphic[IFpoigraphicid] = IFgraphicLayer.add(IFpoigraphic);
			//console.log(IFgraphicLayer);
			//IFurlpart = IFurlpart.slice(IFurlpart.indexOf("poi=")+4, IFurlpart.length);
			
            }
            map.addLayer(IFgraphicLayer);
            //IFgraphicLayer.show();
		}
          });
          
          
      
      }
      
                  // Identify Task (PopUp)
            
            function IFpoigraphicpointf(evt) {
	map.infoWindow.setTitle((evt.graphic.attributes.Title).replace(/¤¤/g, '\''));
	IFinfo = evt.graphic.attributes.Info;
	if (IFinfo.slice(0,1)=="\'") {IFinfo=IFinfo.slice(1);}
	if (IFinfo.slice(-1)==";") {IFinfo=IFinfo.slice(0,-1);}
	if (IFinfo.slice(-1)=="\'") {IFinfo=IFinfo.slice(0,-1);}
	map.infoWindow.setContent(IFinfo.replace(/¤¤/g, '\''));
	map.infoWindow.show(evt.screenPoint,map.getInfoWindowAnchor(evt.screenPoint));
	IFpl = new esri.geometry.Point(evt.mapPoint.x,evt.mapPoint.y);
}
            function initIdentify(map) {
        //create identify tasks and setup parameters 
        identifyTask = new esri.tasks.IdentifyTask("http://willem3.npolar.no/arcgis/rest/services/Svalbard/embed/MapServer");

        identifyParams = new esri.tasks.IdentifyParameters();
        identifyParams.tolerance = 5;
        identifyParams.returnGeometry = true;
        identifyParams.layerIds = visibleLayers;
        identifyParams.layerOption = esri.tasks.IdentifyParameters.LAYER_OPTION_VISIBLE;
        identifyParams.width = map.width;
        identifyParams.height = map.height;
        //console.log('set up ID');

        // Save a reference to the event listener so it can be
        // disconnected when no layers are selected
        identifyHandle = dojo.connect(map, "onClick", executeIdentifyTask);
      }
      
      function updateIdentifyTask() {
        visible = visibleLayers;
        // If no layers are visible set the array value to = -1
        // and disconnect the identify task
        if (visible.length === 0) {
          visible = [-1];
          dojo.disconnect(identifyHandle);
          //map.infoWindow.hide();
          //console.log('disconnected ID');
        } else if ( ! identifyHandle[0] ) { 
          // There are visible layers to re-connect identify task
          // and the identify task is not connected 
          identifyHandle = dojo.connect(map, "onClick", executeIdentifyTask);
          //console.log('connected ID');
        }
        // Update Identifys layers
        identifyParams.layerIds = visible;
      }
            
            function executeIdentifyTask(evt) {
        identifyParams.geometry = evt.mapPoint;
        identifyParams.mapExtent = map.extent;

        var deferred = identifyTask.execute(identifyParams);

        deferred.addCallback(function (response) {
          // response is an array of identify result objects    
          // return an array of features.
          return dojo.map(response, function (result) {
            var feature = result.feature;
            feature.attributes.layerName = result.layerName;

            //console.log(feature.attributes);
 
            var template = new esri.InfoTemplate();
            template.setTitle("${layerName}");
            template.setContent("${*}");
            feature.setInfoTemplate(template);

            return feature;
          });
        });

        map.infoWindow.setFeatures([deferred]);
        map.infoWindow.show(evt.mapPoint);
      }
      mapLayers = [ 
{layerID:9,svbkID:"6,0,0,5,1,0,4,0,1,0,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:10,svbkID:"6,0,0,5,1,0,4,0,1,1,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:12,svbkID:"6,0,0,5,1,0,4,0,1,2,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:13,svbkID:"6,0,0,5,1,0,4,0,3,3,2,4,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:14,svbkID:"6,0,0,5,1,0,4,0,3,3,2,5,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:15,svbkID:"6,0,0,5,1,0,4,0,3,3,2,6,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:16,svbkID:"6,0,0,5,1,0,4,0,3,3,2,7,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:17,svbkID:"6,0,0,5,1,0,4,0,3,3,2,8,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:18,svbkID:"6,0,0,5,1,0,4,0,3,3,2,9,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:19,svbkID:"6,0,0,5,1,0,4,0,3,3,2,10,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:20,svbkID:"6,0,0,5,1,0,4,0,3,3,2,11,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:21,svbkID:"6,0,0,5,1,0,4,0,3,3,2,12,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:22,svbkID:"6,0,0,5,1,0,4,0,3,3,2,13,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:23,svbkID:"6,0,0,5,1,0,4,0,3,3,2,14,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:24,svbkID:"6,0,0,5,1,0,4,0,3,3,2,15,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:25,svbkID:"6,0,0,5,1,0,4,0,3,3,2,15,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:26,svbkID:"6,0,0,5,1,0,4,0,3,3,2,17,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:27,svbkID:"6,0,0,5,1,0,4,0,3,3,2,18,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:28,svbkID:"6,0,0,5,1,0,4,0,3,3,2,19,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:29,svbkID:"6,0,0,5,1,0,4,0,3,3,2,20,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:30,svbkID:"6,0,0,5,1,0,4,0,3,3,2,21,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:31,svbkID:"6,0,0,5,1,0,4,0,3,3,2,22,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:32,svbkID:"6,0,0,5,1,0,4,0,3,3,2,23,3,1,0,10,1,0,9,1,0,8,0,0,12,0,0,0,0,0,11,0,0,"},
{layerID:118,svbkID:"6,0,0,5,1,0,4,1,0,3,1,0,10,1,0,9,1,0,8,1,0,12,0,0,0,0,0,11,0,0,"}]
      function showFullMap (){
      	visibleUrl = "";
      	for (var i = 0; i < mapLayers.length; i++) {
      		if(visibleLayers[0] == mapLayers[i]['layerID']){
      			visibleUrl = mapLayers[i]['svbkID'];
      			//console.log(mapLayers[i]['layerID'], mapLayers[i]['layerName']);
      		}
      	}
      	var extent = Math.round(map.extent.xmin) + "," + Math.round(map.extent.ymin) + "," + Math.round(map.extent.xmax) + "," + Math.round(map.extent.ymax);
      	dojo.byId('fullmap').innerHTML = '<a id="fullmaplink" href="http://svalbardkartet.npolar.no/Viewer.html?Viewer=Svalbardkartet&extent='+ extent + '&layers=' + visibleUrl +'" target="_blank">Vis i Svalbardkartet</a>';
      	//layers=
      }

      function onProjectComplete(graphics) {
          if (graphics && graphics.length == 1) {
              var g = graphics[0];
              dojo.byId('wgs84coords').innerHTML = dojo.string.substitute("Markert punkt har (Lat, Long): ${1}, ${0}", [dojo.number.format(g.geometry.x, { places: decimalPlacesWGS84 }), dojo.number.format(g.geometry.y, { places: decimalPlacesWGS84 })]);
              dojo.style('wgs84coords', 'display', 'block');
          }
      }

      dojo.addOnLoad(init);
    </script>
  </head>
  
  <body class="claro">
    <div id="map">
    	<div id="nplogo"><img src="images/iframe_nplogo.png" /></div>
    	<div id="backgroundbottom">
    		<div id="fullmap"><a id="fullmaplink"  href="http://svalbardkartet.npolar.no/Viewer.html?Viewer=Svalbardkartet" target="_blank">Vis i Svalbardkartet</a></div>
    		<div id="copyright" title="Norsk Polarinstitutts forside">© <a href="http://npolar.no" target="_blank">Norsk Polarinstitutt</a></div>
    	</div>
    	
    </div>
    <div style="display: none; position: absolute; left: 20px; bottom: 20px;" id="wgs84coords"></div>
  </body>
</html>